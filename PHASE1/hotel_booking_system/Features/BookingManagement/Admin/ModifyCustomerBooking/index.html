<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin Modify Booking — Integrated Layout</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

  <style>
    :root {
      --admin-start: #4f46e5;
      --admin-end: #06b6d4;
    }
    .admin-gradient { background: linear-gradient(135deg, var(--admin-start) 0%, var(--admin-end) 100%); }
    .tab-active {
      background: linear-gradient(135deg, rgba(79,70,229,0.12), rgba(6,182,212,0.06));
      border-bottom: 4px solid rgba(79,70,229,0.28);
      color: #1f2937; font-weight:700; transform:translateY(-2px);
      border-top-left-radius:12px; border-top-right-radius:12px;
    }
    .tab-inactive { background:#f8fafc; border-bottom:2px solid #e6eefc; color:#374151; }
    .clock-pill { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
                 background:linear-gradient(90deg, rgba(99,102,241,0.08), rgba(6,182,212,0.04));
                 border:1px solid rgba(99,102,241,0.12); color:#0f172a; font-weight:600; }
    .small { font-size:0.85rem; }
    /* keep modal backdrop above sidebar/navbar */
    #modalsContainer > .fixed { z-index: 70; }
  </style>
</head>
<body class="bg-gray-50">

  <!-- Navbar injected here -->
  <div id="navbar"></div>

  <!-- Sidebar injected here -->
  <div id="sidebar" class="fixed top-16 left-0 w-64 h-screen shadow-lg bg-white"></div>

  <!-- Main area (keeps your ml-64 layout) -->
  <main class="ml-64 pt-16 p-8 h-screen overflow-y-auto space-y-8">

    <!-- Top header card -->
    <div class="relative rounded-2xl border-2 border-yellow-500 bg-yellow-50 py-8 text-center shadow">
      <h2 class="text-3xl text-gray-800 font-bold">Booking Details — Modify (Admin)</h2>
      <p class="text-gray-600 mt-2">Overview + modify guest requests (booking id shown below)</p>
    </div>

    <!-- Compact header and actions -->
    <div class="flex items-center justify-between gap-4">
      <div class="flex items-center gap-4">
        <button id="backBtn" class="px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg flex items-center gap-2">
          <span class="material-icons text-sm">arrow_back</span> Back
        </button>
        <div>
          <div class="text-xs text-gray-500">Booking</div>
          <div class="text-xl font-semibold text-indigo-700" id="bookingIdHeader">#B1001</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <div id="globalOfferStatus" class="text-sm text-gray-700 small"></div>
        <div id="countdownPill" class="clock-pill hidden"><i class="fas fa-clock text-indigo-600"></i><span id="globalCountdownLabel">00:00:00</span></div>
      </div>
    </div>

    <!-- TABS card -->
    <div class="bg-white rounded-2xl shadow border border-gray-100">
      <!-- tabs nav -->
      <div class="border-b border-gray-200 bg-gradient-to-r from-gray-50 to-gray-100 rounded-t-2xl">
        <div class="flex" role="tablist">
          <button id="tab-details" class="flex-1 py-4 px-6 text-left tab-active" role="tab" aria-selected="true">
            <div class="flex items-center gap-3">
              <div class="w-9 h-9 bg-indigo-600 text-white rounded-full flex items-center justify-center text-sm font-bold">1</div>
              <div>
                <div class="font-semibold text-base">Customer Details</div>
                <div class="text-xs text-gray-500">Booking info & requested changes</div>
              </div>
            </div>
          </button>
          <button id="tab-rooms" class="flex-1 py-4 px-6 text-left tab-inactive rounded-tr-2xl" role="tab" aria-selected="false">
            <div class="flex items-center gap-3">
              <div class="w-9 h-9 bg-gray-200 text-gray-600 rounded-full flex items-center justify-center text-sm font-medium">2</div>
              <div>
                <div class="font-semibold text-base">Room Allocation</div>
                <div class="text-xs text-gray-500">Search & select rooms for customer</div>
              </div>
            </div>
          </button>
        </div>
      </div>

      <div id="tabPanels" class="p-6 space-y-6">

        <!-- Panel 1: Customer Details -->
        <section id="panel-details" class="space-y-4">
          <div class="bg-indigo-50 border border-indigo-100 rounded-lg p-4 flex items-center justify-between">
            <div>
              <h3 class="text-indigo-700 font-semibold">Booking Dates (Global)</h3>
              <div class="text-sm text-gray-700">
                Check-in: <span id="oldCheckIn"></span> → <span id="newCheckIn" class="font-semibold text-indigo-600"></span><br>
                Check-out: <span id="oldCheckOut"></span> → <span id="newCheckOut" class="font-semibold text-indigo-600"></span>
              </div>
            </div>
            <div class="text-right text-sm text-gray-600">
              <div>Customer: <strong id="customerName">—</strong></div>
              <div id="customerContact">—</div>
            </div>
          </div>

          <div class="bg-white rounded-lg border border-gray-200 shadow overflow-hidden">
            <div class="bg-indigo-50 px-4 py-3 border-b">
              <h3 class="font-semibold text-gray-800">Room-by-Room Comparison</h3>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-indigo-50">
                  <tr>
                    <th class="px-3 py-2 text-left">Room</th>
                    <th class="px-3 py-2 text-left">Old Type</th>
                    <th class="px-3 py-2 text-left">New Type</th>
                    <th class="px-3 py-2 text-left">Adults</th>
                    <th class="px-3 py-2 text-left">Children</th>
                    <th class="px-3 py-2 text-left">Status</th>
                  </tr>
                </thead>
                <tbody id="comparisonTableBody" class="divide-y divide-gray-100"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Panel 2: Room Allocation & Locking -->
        <section id="panel-rooms" class="hidden space-y-4">
          <div class="bg-white rounded-lg border border-gray-200 p-4 shadow">
            <div class="flex items-center justify-between">
              <div>
                <h3 class="font-semibold text-gray-800">Room Selection Settings</h3>
                <p class="text-xs text-gray-500">Configure room selection preferences and options.</p>
              </div>
              <div class="flex items-center gap-3">
                <input id="durationHours" type="number" min="0" value="0" class="w-16 border rounded px-2 py-1 text-sm" />
                <label class="text-sm text-gray-600">hrs</label>
                <input id="durationMinutes" type="number" min="0" max="59" value="30" class="w-16 border rounded px-2 py-1 text-sm" />
                <label class="text-sm text-gray-600">mins</label>
                <button id="resetSelectedBtn" class="px-3 py-2 border rounded text-sm bg-red-50 text-red-700">Reset Selected</button>
              </div>
            </div>
          </div>

          <div id="roomRequestsContainer" class="space-y-3"></div>

          <div class="bg-white rounded-lg border border-gray-200 shadow overflow-hidden">
            <div class="bg-indigo-50 px-4 py-3 border-b flex items-center justify-between">
              <h3 class="font-semibold text-gray-800">Selected Rooms Summary</h3>
              <div class="text-xs text-gray-500">Currently selected rooms for this booking</div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-indigo-50">
                  <tr>
                    <th class="px-3 py-2 text-left">Room No</th>
                    <th class="px-3 py-2 text-left">Type</th>
                    <th class="px-3 py-2 text-right">Rate / night</th>
                    <th class="px-3 py-2 text-right">Nights</th>
                    <th class="px-3 py-2 text-right">Total</th>
                    <th class="px-3 py-2 text-center">Remove</th>
                  </tr>
                </thead>
                <tbody id="selectedCartBody" class="divide-y divide-gray-100"></tbody>
                <tfoot class="bg-indigo-50">
                  <tr>
                    <td colspan="4" class="px-3 py-2 text-right font-bold">Cart Totals:</td>
                    <td class="px-3 py-2 text-right font-semibold" id="selectedCartTotal">₹0</td>
                    <td></td>
                  </tr>
                </tfoot>
              </table>
            </div>
            
            <!-- Send to Customer Button -->
            <div class="px-4 py-3 bg-gray-50 border-t">
              <button id="sendToCustomerBtn" class="w-full px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 disabled:bg-gray-300 disabled:text-gray-500 disabled:cursor-not-allowed transition-colors" disabled>
                <i class="fas fa-paper-plane mr-2"></i>
                Send to Customer
              </button>
              <div class="text-xs text-gray-500 mt-1 text-center" id="sendButtonStatus">Please assign rooms to all requests before sending</div>
            </div>
          </div>

          <!-- Old Rooms (Original Booking) Summary -->
          <div class="bg-white rounded-lg border border-gray-200 shadow overflow-hidden">
            <div class="bg-amber-50 px-4 py-3 border-b flex items-center justify-between">
              <h3 class="font-semibold text-gray-800">Old Rooms (Original Booking)</h3>
              <div class="text-xs text-gray-500">Previously booked rooms</div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-amber-50">
                  <tr>
                    <th class="px-3 py-2 text-left">Room No</th>
                    <th class="px-3 py-2 text-left">Room Type</th>
                    <th class="px-3 py-2 text-right">Nights</th>
                    <th class="px-3 py-2 text-right">Rate / night</th>
                    <th class="px-3 py-2 text-right">Total</th>
                  </tr>
                </thead>
                <tbody id="oldRoomsBody" class="divide-y divide-gray-100"></tbody>
                <tfoot class="bg-amber-50">
                  <tr>
                    <td colspan="4" class="px-3 py-2 text-right font-bold">Old Total:</td>
                    <td class="px-3 py-2 text-right font-semibold" id="oldRoomsTotal">₹0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <!-- New Rooms (Current Selection) Summary -->
          <div class="bg-white rounded-lg border border-gray-200 shadow overflow-hidden">
            <div class="bg-emerald-50 px-4 py-3 border-b flex items-center justify-between">
              <h3 class="font-semibold text-gray-800">New Rooms (Current Selection)</h3>
              <div class="text-xs text-gray-500">Currently selected rooms</div>
            </div>
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="bg-emerald-50">
                  <tr>
                    <th class="px-3 py-2 text-left">Room No</th>
                    <th class="px-3 py-2 text-left">Room Type</th>
                    <th class="px-3 py-2 text-right">Nights</th>
                    <th class="px-3 py-2 text-right">Rate / night</th>
                    <th class="px-3 py-2 text-right">Total</th>
                  </tr>
                </thead>
                <tbody id="newRoomsBody" class="divide-y divide-gray-100"></tbody>
                <tfoot class="bg-emerald-50">
                  <tr>
                    <td colspan="4" class="px-3 py-2 text-right font-bold">New Total:</td>
                    <td class="px-3 py-2 text-right font-semibold" id="newRoomsTotal">₹0</td>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>

          <!-- Net Difference Section -->
          <div class="bg-white rounded-lg border border-gray-200 shadow overflow-hidden">
            <div class="bg-slate-50 px-4 py-3 border-b">
              <h3 class="font-semibold text-gray-800">Net Difference Summary</h3>
            </div>
            <div class="p-4">
              <div class="space-y-3">
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                  <span class="text-sm font-medium text-gray-600">Old Total:</span>
                  <span class="font-semibold text-gray-800" id="netOldTotal">₹0</span>
                </div>
                <div class="flex justify-between items-center py-2 border-b border-gray-100">
                  <span class="text-sm font-medium text-gray-600">New Total:</span>
                  <span class="font-semibold text-gray-800" id="netNewTotal">₹0</span>
                </div>
                <div class="flex justify-between items-center py-3 bg-gray-50 px-3 rounded-lg">
                  <span class="text-base font-bold text-gray-800">Net Difference:</span>
                  <div class="text-right">
                    <div class="font-bold text-lg" id="netDifference">₹0</div>
                    <div class="text-xs" id="netDifferenceStatus">No Change</div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </section>

      </div>
    </div>

    <!-- Footer small -->
    <div class="text-center text-xs text-gray-500">LuxuryStay Admin Prototype — integrated layout</div>
  </main>

  <!-- Modals container -->
  <div id="modalsContainer"></div>

  <!-- Toast -->
  <div id="toast" class="fixed top-14 right-6 bg-indigo-600 text-white px-6 py-3 rounded-lg shadow-lg transform -translate-y-6 opacity-0 transition-all duration-300 z-60"></div>

<script>
/* ============================
   Inject Navbar + Sidebar (keeps your code)
   ============================ */
fetch('/Features/Components/Navbars/AdminMainPageNavbar/index.html')
  .then(r => r.text())
  .then(html => {
    document.getElementById('navbar').innerHTML = html;
    // init notifications if your navbar provides containers
    if(typeof initNotifications === "function") initNotifications();
  })
  .catch(err => {
    console.warn('Navbar load failed, using fallback header', err);
    document.getElementById('navbar').innerHTML = `
      <div class="fixed top-0 left-0 right-0 bg-white shadow z-30">
        <div class="max-w-7xl mx-auto p-4 flex justify-between items-center">
          <div class="font-bold text-yellow-600">LuxuryStay (fallback)</div>
        </div>
      </div>`;
  });

fetch('/Features/Components/Sidebars/AdminMainPageSidebar/index.html')
  .then(r => r.text())
  .then(html => {
    document.getElementById('sidebar').innerHTML = html;
    // highlight booking link if present
    const currentPage = "booking";
    document.querySelectorAll('#sidebar a').forEach(link => {
      if(link.dataset && link.dataset.page === currentPage){
        link.classList.add('text-yellow-600','font-bold');
      }
    });
  })
  .catch(err => {
    console.warn('Sidebar load failed', err);
  });

/* ============================
   Dummy booking data & inventory (replace with real API)
   ============================ */
const booking = {
  id: "B1001",
  createdAt: "2025-09-15",
  oldCheckIn: "2025-09-21",
  newCheckIn: "2025-09-25",
  oldCheckOut: "2025-09-25",
  newCheckOut: "2025-09-29",
  customer: { name: "Arjun Kumar", email:"arjun.kumar@example.com", phone:"+91 99887 77665", notes: "High floor preferred" },
  rooms: [
    { uid:"r1", id:1, oldRoomNo:"101", oldType:"Deluxe Room", newType:"Executive Suite", oldAdults:2, newAdults:3, oldChildren:0, newChildren:1, oldPrice:12000, newPrice:18000 },
    { uid:"r2", id:2, oldRoomNo:"201", oldType:"Executive Suite", newType:"Executive Suite", oldAdults:2, newAdults:2, oldChildren:0, newChildren:0, oldPrice:18000, newPrice:18000 },
    { uid:"r3", id:3, oldRoomNo:"102", oldType:"Deluxe Room", newType:"Deluxe Room", oldAdults:1, newAdults:1, oldChildren:0, newChildren:0, oldPrice:12000, newPrice:12000 },
    { uid:"r4", id:4, oldRoomNo:"301", oldType:"Family Room", newType:"Presidential Suite", oldAdults:4, newAdults:6, oldChildren:2, newChildren:2, oldPrice:14000, newPrice:25000 }
  ]
};

const roomCatalog = [
  { type:"Deluxe Room", price:12000, capacity:2, description:"Standard luxury room for couples" }, 
  { type:"Executive Suite", price:18000, capacity:4, description:"Premium suite with extra space" }, 
  { type:"Family Room", price:14000, capacity:6, description:"Spacious room perfect for families" },
  { type:"Presidential Suite", price:25000, capacity:8, description:"Ultimate luxury suite for VIP guests" }
];

const roomInventory = [
  { roomNo:"101", type:"Deluxe Room", available:true },
  { roomNo:"102", type:"Deluxe Room", available:false }, // Occupied
  { roomNo:"103", type:"Deluxe Room", available:true },
  { roomNo:"201", type:"Executive Suite", available:true },
  { roomNo:"202", type:"Executive Suite", available:false }, // Occupied  
  { roomNo:"203", type:"Executive Suite", available:true },
  { roomNo:"301", type:"Family Room", available:true },
  { roomNo:"302", type:"Family Room", available:false }, // Occupied
  { roomNo:"303", type:"Family Room", available:true },
  { roomNo:"401", type:"Presidential Suite", available:false }, // All Presidential Suites occupied to force recommendations
  { roomNo:"402", type:"Presidential Suite", available:false },
  { roomNo:"403", type:"Presidential Suite", available:false }
];

/* ============================
   App state
   - selectedRooms: currently selected rooms for modification
   - roomAssignments: tracks which room is assigned to which request
   ============================ */
const state = {
  selectedRooms: {},  // roomNo -> {roomNo,type,rate,nights}
  roomAssignments: {} // requestId -> roomNo (one room per request)
};

/* ============================
   DOM helpers & initial render
   ============================ */
const $ = id => document.getElementById(id);
const fmtINR = n => "₹" + Number(n).toLocaleString("en-IN");
function nightsBetween(ci, co) {
  const a = new Date(ci + "T00:00:00"), b = new Date(co + "T00:00:00");
  const d = Math.floor((b - a) / (1000*60*60*24));
  return Math.max(1, d);
}

function initUI(){
  // header
  $("bookingIdHeader").textContent = booking.id;
  $("oldCheckIn").textContent = booking.oldCheckIn;
  $("newCheckIn").textContent = booking.newCheckIn;
  $("oldCheckOut").textContent = booking.oldCheckOut;
  $("newCheckOut").textContent = booking.newCheckOut;
  $("customerName").textContent = booking.customer.name;
  $("customerContact").textContent = `${booking.customer.email} • ${booking.customer.phone}`;

  renderComparisonTable();
  renderRoomRequestCards();
  renderSelectedCart();
  hookTabs();
  hookResetSelected();
  hookSendToCustomer();
  $("backBtn").addEventListener("click", ()=> history.back());
}

function renderComparisonTable(){
  const tbody = $("comparisonTableBody");
  tbody.innerHTML = "";
  booking.rooms.forEach(r => {
    const changed = r.oldType !== r.newType || r.oldAdults !== r.newAdults || r.oldChildren !== r.newChildren;
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="px-3 py-2">${r.oldRoomNo ? r.oldRoomNo : `Room #${r.id}`}</td>
      <td class="px-3 py-2">${r.oldType}</td>
      <td class="px-3 py-2 ${r.oldType!==r.newType ? 'text-indigo-600 font-semibold':''}">${r.newType}</td>
      <td class="px-3 py-2">${r.oldAdults} → <span class="text-indigo-600 font-semibold">${r.newAdults}</span></td>
      <td class="px-3 py-2">${r.oldChildren} → <span class="text-indigo-600 font-semibold">${r.newChildren}</span></td>
      <td class="px-3 py-2">${changed ? '<span class="text-yellow-600 font-semibold">Change requested</span>' : '<span class="text-gray-500">No change</span>'}</td>
    `;
    tbody.appendChild(tr);
  });
}

function renderRoomRequestCards(){
  const container = $("roomRequestsContainer");
  container.innerHTML = "";
  booking.rooms.forEach((r, idx) => {
    const changed = r.oldType !== r.newType || r.oldAdults !== r.newAdults || r.oldChildren !== r.newChildren;
    const assignedRoom = state.roomAssignments[r.uid];
    const isAssigned = assignedRoom && state.selectedRooms[assignedRoom];
    
    const card = document.createElement("div");
    card.className = `bg-white rounded-xl border-2 shadow-sm transition-all hover:shadow-md ${
      changed ? 'border-amber-200 bg-amber-50' : 'border-gray-200'
    }`;
    
    card.innerHTML = `
      <div class="p-6">
        <!-- Header Section -->
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <div class="w-10 h-10 bg-gradient-to-r from-indigo-500 to-blue-500 text-white rounded-lg flex items-center justify-center font-bold">
              ${r.id}
            </div>
            <div>
              <h4 class="font-semibold text-gray-800">Room Request #${r.id}</h4>
              <p class="text-sm text-gray-500">${r.oldRoomNo ? `Originally Room ${r.oldRoomNo}` : 'New request'}</p>
            </div>
          </div>
          
          ${isAssigned ? 
            `<div class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium flex items-center gap-2">
              <i class="fas fa-check-circle"></i>
              Room ${assignedRoom}
            </div>` : 
            changed ? 
              `<div class="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-sm font-medium flex items-center gap-2">
                <i class="fas fa-clock"></i>
                Needs Assignment
              </div>` :
              `<div class="px-3 py-1 bg-gray-100 text-gray-600 rounded-full text-sm font-medium">
                No Action Needed
              </div>`
          }
        </div>
        
        <!-- Details Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
          <!-- Room Type -->
          <div class="bg-gray-50 rounded-lg p-3">
            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Room Type</div>
            ${r.oldType !== r.newType ? 
              `<div class="text-sm">
                <span class="text-gray-600">${r.oldType}</span>
                <i class="fas fa-arrow-right text-gray-400 mx-2"></i>
                <span class="font-semibold text-indigo-600">${r.newType}</span>
              </div>` :
              `<div class="text-sm font-medium text-gray-800">${r.newType}</div>`
            }
          </div>
          
          <!-- Dates -->
          <div class="bg-gray-50 rounded-lg p-3">
            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Check-in → Check-out</div>
            <div class="text-sm font-medium text-gray-800">
              ${booking.newCheckIn} → ${booking.newCheckOut}
            </div>
          </div>
          
          <!-- Adults -->
          <div class="bg-gray-50 rounded-lg p-3">
            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Adults</div>
            ${r.oldAdults !== r.newAdults ? 
              `<div class="text-sm">
                <span class="text-gray-600">${r.oldAdults}</span>
                <i class="fas fa-arrow-right text-gray-400 mx-2"></i>
                <span class="font-semibold text-indigo-600">${r.newAdults}</span>
              </div>` :
              `<div class="text-sm font-medium text-gray-800">${r.newAdults}</div>`
            }
          </div>
          
          <!-- Children -->
          <div class="bg-gray-50 rounded-lg p-3">
            <div class="text-xs font-medium text-gray-500 uppercase tracking-wide mb-1">Children</div>
            ${r.oldChildren !== r.newChildren ? 
              `<div class="text-sm">
                <span class="text-gray-600">${r.oldChildren}</span>
                <i class="fas fa-arrow-right text-gray-400 mx-2"></i>
                <span class="font-semibold text-indigo-600">${r.newChildren}</span>
              </div>` :
              `<div class="text-sm font-medium text-gray-800">${r.newChildren}</div>`
            }
          </div>
        </div>
        
        <!-- Action Section -->
        <div class="flex items-center justify-between pt-4 border-t border-gray-200">
          <div class="text-sm text-gray-600">
            ${changed ? 
              `<span class="flex items-center gap-2">
                <i class="fas fa-exclamation-triangle text-amber-500"></i>
                Requires room assignment
              </span>` :
              `<span class="flex items-center gap-2">
                <i class="fas fa-check-circle text-green-500"></i>
                No changes - keep original room
              </span>`
            }
          </div>
          
          <div class="flex gap-2">
            ${!changed ? '' :
              isAssigned ? 
                `<button class="removeRoomBtn px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2" data-request-id="${r.uid}">
                  <i class="fas fa-times"></i>
                  Remove Assignment
                </button>` :
                `<button class="searchRoomsBtn px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center gap-2" data-idx="${idx}" data-request-id="${r.uid}">
                  <i class="fas fa-search"></i>
                  Find Rooms
                </button>`
            }
          </div>
        </div>
      </div>
    `;
    container.appendChild(card);
  });

  // attach search handlers
  Array.from(document.querySelectorAll(".searchRoomsBtn")).forEach(btn => {
    btn.addEventListener("click", (e) => {
      openSearchModalForRoom(Number(btn.dataset.idx), btn.dataset.requestId);
    });
  });

  // attach remove handlers
  Array.from(document.querySelectorAll(".removeRoomBtn")).forEach(btn => {
    btn.addEventListener("click", (e) => {
      const requestId = btn.dataset.requestId;
      const assignedRoom = state.roomAssignments[requestId];
      if (assignedRoom) {
        delete state.selectedRooms[assignedRoom];
        delete state.roomAssignments[requestId];
        renderRoomRequestCards();
        renderSelectedCart();
        showToast("Room unassigned successfully.", "success");
      }
    });
  });
  
  // Update Send to Customer button state after rendering room requests
  updateSendToCustomerButton();
}

function updateSendToCustomerButton() {
  const sendBtn = $("sendToCustomerBtn");
  const statusText = $("sendButtonStatus");
  
  // Get requests that need room assignments (those with changes)
  const requestsNeedingRooms = booking.rooms.filter(r => {
    const changed = r.newType !== r.oldType || r.newAdults !== r.oldAdults || r.newChildren !== r.oldChildren;
    return changed;
  });
  
  // Check if all requests that need rooms have assignments
  const allAssigned = requestsNeedingRooms.every(r => state.roomAssignments[r.uid]);
  
  if (requestsNeedingRooms.length === 0) {
    sendBtn.disabled = true;
    statusText.textContent = "No room changes detected";
  } else if (allAssigned) {
    sendBtn.disabled = false;
    statusText.textContent = `Ready to send ${Object.keys(state.roomAssignments).length} room(s) to customer`;
  } else {
    sendBtn.disabled = true;
    const assignedCount = Object.keys(state.roomAssignments).length;
    const totalCount = requestsNeedingRooms.length;
    statusText.textContent = `${assignedCount}/${totalCount} rooms assigned - Please assign all rooms before sending`;
  }
}

function renderSelectedCart(){
  const tbody = $("selectedCartBody");
  tbody.innerHTML = "";
  let total = 0;
  const nights = nightsBetween(booking.newCheckIn, booking.newCheckOut);
  Object.values(state.selectedRooms).forEach(item => {
    const tr = document.createElement("tr");
    const tot = item.rate * nights;
    total += tot;
    tr.innerHTML = `
      <td class="px-3 py-2">${item.roomNo}</td>
      <td class="px-3 py-2">${item.type}</td>
      <td class="px-3 py-2 text-right">${fmtINR(item.rate)}</td>
      <td class="px-3 py-2 text-right">${nights}</td>
      <td class="px-3 py-2 text-right">${fmtINR(tot)}</td>
      <td class="px-3 py-2 text-center"><button class="remove-selected-btn px-2 py-1 bg-red-50 text-red-700 rounded text-xs" data-room="${item.roomNo}">Remove</button></td>
    `;
    tbody.appendChild(tr);
  });
  $("selectedCartTotal").textContent = fmtINR(total);

  Array.from(document.querySelectorAll(".remove-selected-btn")).forEach(b => {
    b.addEventListener("click", ()=> {
      const roomNo = b.dataset.room;
      const room = state.selectedRooms[roomNo];
      
      // Also remove from room assignments if this room was assigned to a request
      if (room && room.requestId) {
        delete state.roomAssignments[room.requestId];
      }
      
      delete state.selectedRooms[roomNo];
      renderSelectedCart();
      renderRoomRequestCards();
    });
  });
  
  // Update Send to Customer button state after rendering selected cart
  updateSendToCustomerButton();
  
  // Also update the old/new rooms comparison tables
  renderOldRoomsTable();
  renderNewRoomsTable();
  renderNetDifferenceSection();
}

function renderOldRoomsTable(){
  const tbody = $("oldRoomsBody");
  tbody.innerHTML = "";
  let total = 0;
  const nights = nightsBetween(booking.oldCheckIn, booking.oldCheckOut);
  
  if (booking.rooms.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="px-3 py-4 text-center text-gray-500 text-sm">No original rooms found</td>
      </tr>
    `;
  } else {
    // Use actual original booking room data
    booking.rooms.forEach(room => {
      const tr = document.createElement("tr");
      const rate = room.oldPrice;
      const roomTotal = rate * nights;
      total += roomTotal;
      
      // Use actual room number from original booking
      const roomNo = room.oldRoomNo || `R${room.id}`;
      
      tr.innerHTML = `
        <td class="px-3 py-2">${roomNo}</td>
        <td class="px-3 py-2">${room.oldType}</td>
        <td class="px-3 py-2 text-right">${nights}</td>
        <td class="px-3 py-2 text-right">${fmtINR(rate)}</td>
        <td class="px-3 py-2 text-right">${fmtINR(roomTotal)}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  $("oldRoomsTotal").textContent = fmtINR(total);
  return total;
}

function renderNewRoomsTable(){
  const tbody = $("newRoomsBody");
  tbody.innerHTML = "";
  let total = 0;
  const nights = nightsBetween(booking.newCheckIn, booking.newCheckOut);
  
  const selectedRooms = Object.values(state.selectedRooms);
  
  if (selectedRooms.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="px-3 py-4 text-center text-gray-500 text-sm">No rooms selected yet</td>
      </tr>
    `;
  } else {
    // Use currently selected rooms
    selectedRooms.forEach(item => {
      const tr = document.createElement("tr");
      const roomTotal = item.rate * nights;
      total += roomTotal;
      
      tr.innerHTML = `
        <td class="px-3 py-2">${item.roomNo}</td>
        <td class="px-3 py-2">${item.type}</td>
        <td class="px-3 py-2 text-right">${nights}</td>
        <td class="px-3 py-2 text-right">${fmtINR(item.rate)}</td>
        <td class="px-3 py-2 text-right">${fmtINR(roomTotal)}</td>
      `;
      tbody.appendChild(tr);
    });
  }
  
  $("newRoomsTotal").textContent = fmtINR(total);
  return total;
}

function renderNetDifferenceSection(){
  // Calculate totals
  const oldTotal = calculateOldRoomsTotal();
  const newTotal = calculateNewRoomsTotal();
  const difference = newTotal - oldTotal;
  
  // Update display values
  $("netOldTotal").textContent = fmtINR(oldTotal);
  $("netNewTotal").textContent = fmtINR(newTotal);
  $("netDifference").textContent = fmtINR(Math.abs(difference));
  
  const differenceElement = $("netDifference");
  const statusElement = $("netDifferenceStatus");
  
  // Reset classes
  differenceElement.className = "font-bold text-lg";
  
  if (difference > 0) {
    // Customer pays extra
    differenceElement.classList.add("text-red-600");
    statusElement.textContent = "Customer Pays Extra";
    statusElement.className = "text-xs text-red-500";
  } else if (difference < 0) {
    // Refund to customer
    differenceElement.classList.add("text-green-600");
    statusElement.textContent = "Refund to Customer";
    statusElement.className = "text-xs text-green-500";
  } else {
    // No difference
    differenceElement.classList.add("text-gray-600");
    statusElement.textContent = "No Change";
    statusElement.className = "text-xs text-gray-500";
  }
}

function calculateOldRoomsTotal(){
  const nights = nightsBetween(booking.oldCheckIn, booking.oldCheckOut);
  return booking.rooms.reduce((total, room) => total + (room.oldPrice * nights), 0);
}

function calculateNewRoomsTotal(){
  const nights = nightsBetween(booking.newCheckIn, booking.newCheckOut);
  return Object.values(state.selectedRooms).reduce((total, room) => total + (room.rate * nights), 0);
}

/* ============================
   Search modal - Single selection for room requests
   ============================ */
function openSearchModalForRoom(roomIndex, requestId){
  const req = booking.rooms[roomIndex];
  const modalId = `modal-search-${req.uid}`;
  const mc = $("modalsContainer");
  
  // Get available rooms of the requested type
  const exactMatches = roomInventory.filter(r => 
    r.type === req.newType && 
    r.available && 
    !state.selectedRooms[r.roomNo]
  );
  
  // Get recommended rooms (different types but available)
  let recommendations = [];
  if (exactMatches.length === 0) {
    // Get all available rooms that are not the requested type
    const availableAlternatives = roomInventory.filter(r => 
      r.type !== req.newType && 
      r.available && 
      !state.selectedRooms[r.roomNo]
    );
    
    // Prioritize recommendations based on capacity and upgrade potential
    const requestedCapacity = req.newAdults + req.newChildren;
    const sortedAlternatives = availableAlternatives.sort((a, b) => {
      const aCatalog = roomCatalog.find(rc => rc.type === a.type);
      const bCatalog = roomCatalog.find(rc => rc.type === b.type);
      
      if (!aCatalog || !bCatalog) return 0;
      
      // Prefer rooms that can accommodate the guests
      const aCanAccommodate = aCatalog.capacity >= requestedCapacity;
      const bCanAccommodate = bCatalog.capacity >= requestedCapacity;
      
      if (aCanAccommodate && !bCanAccommodate) return -1;
      if (!aCanAccommodate && bCanAccommodate) return 1;
      
      // If both can accommodate or both cannot, sort by price (cheaper first)
      return aCatalog.price - bCatalog.price;
    });
    
    recommendations = sortedAlternatives.slice(0, 6); // Show up to 6 recommendations
  }
  
  mc.innerHTML = `
    <div id="${modalId}" class="fixed inset-0 z-70 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black bg-opacity-30"></div>
      <div class="relative bg-white rounded-2xl p-6 shadow-2xl w-full max-w-4xl">
        <button id="${modalId}-close" class="absolute top-4 right-4 p-2 rounded bg-gray-100 hover:bg-gray-200"><i class="fas fa-times"></i></button>
        <h3 class="text-lg font-semibold mb-2">Select Room for Request #${req.id}</h3>
        <p class="text-sm text-gray-600 mb-4">Requested: <strong>${req.newType}</strong> for ${req.newAdults} adults, ${req.newChildren} children</p>
        
        <div class="space-y-4 max-h-96 overflow-y-auto">
          ${exactMatches.length > 0 ? `
            <div>
              <h4 class="font-medium text-gray-800 mb-2 flex items-center gap-2">
                <i class="fas fa-check-circle text-green-500"></i>
                Available ${req.newType} Rooms
              </h4>
              <div id="${modalId}-exact-list" class="grid grid-cols-1 gap-2"></div>
            </div>
          ` : ''}
          
          ${recommendations.length > 0 ? `
            <div>
              <h4 class="font-medium text-gray-800 mb-2 flex items-center gap-2">
                <i class="fas fa-lightbulb text-yellow-500"></i>
                Recommended Alternative Rooms
              </h4>
              <p class="text-xs text-gray-500 mb-2">No ${req.newType} available. Consider these alternatives:</p>
              <div id="${modalId}-rec-list" class="grid grid-cols-1 gap-2"></div>
            </div>
          ` : ''}
          
          ${exactMatches.length === 0 && recommendations.length === 0 ? `
            <div class="text-center py-8 text-gray-500">
              <i class="fas fa-bed text-4xl text-gray-300 mb-4"></i>
              <p class="font-medium">No rooms available for this request</p>
              <p class="text-sm mt-2">Requested: <strong>${req.newType}</strong> for ${req.newAdults} adults, ${req.newChildren} children</p>
              <p class="text-xs mt-2 text-gray-400">All rooms are currently occupied or assigned to other requests.</p>
              <div class="mt-4 p-3 bg-gray-50 rounded-lg text-xs text-left">
                <p class="font-medium text-gray-700 mb-2">Suggestions:</p>
                <ul class="space-y-1 text-gray-600">
                  <li>• Check if other room assignments can be modified</li>
                  <li>• Consider adjusting the check-in/check-out dates</li>
                  <li>• Contact guest to discuss alternative room types</li>
                </ul>
              </div>
            </div>
          ` : ''}
        </div>
        
        <div class="mt-4 flex justify-end gap-2">
          <button id="${modalId}-cancel" class="px-4 py-2 border rounded text-sm">Cancel</button>
        </div>
      </div>
    </div>
  `;

  // Populate exact matches
  if (exactMatches.length > 0) {
    const exactList = $(`${modalId}-exact-list`);
    exactMatches.forEach(room => {
      const div = document.createElement("div");
      div.className = "p-3 border rounded-lg hover:bg-green-50 hover:border-green-300 cursor-pointer transition-all";
      div.innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <div class="font-medium text-lg">${room.roomNo}</div>
            <div class="text-sm text-gray-600">${room.type}</div>
            <div class="text-xs text-green-600 mt-1">✓ Perfect match</div>
          </div>
          <div class="text-right">
            <div class="text-lg font-semibold text-gray-800">${fmtINR(getRoomPrice(room.type))}</div>
            <div class="text-xs text-gray-500">per night</div>
          </div>
        </div>
      `;
      div.addEventListener("click", () => assignRoomToRequest(room.roomNo, requestId, modalId));
      exactList.appendChild(div);
    });
  }

  // Populate recommendations
  if (recommendations.length > 0) {
    const recList = $(`${modalId}-rec-list`);
    const requestedCapacity = req.newAdults + req.newChildren;
    
    recommendations.forEach(room => {
      const roomCatalogInfo = roomCatalog.find(rc => rc.type === room.type);
      const canAccommodate = roomCatalogInfo && roomCatalogInfo.capacity >= requestedCapacity;
      const isUpgrade = roomCatalogInfo && getRoomPrice(room.type) > getRoomPrice(req.newType);
      
      let reasonText = "⚡ Alternative option";
      let reasonClass = "text-yellow-600";
      
      if (canAccommodate && isUpgrade) {
        reasonText = "⭐ Upgrade - Perfect fit";
        reasonClass = "text-blue-600";
      } else if (canAccommodate) {
        reasonText = "✓ Can accommodate guests";
        reasonClass = "text-green-600";
      } else if (isUpgrade) {
        reasonText = "⭐ Upgrade option";
        reasonClass = "text-blue-600";
      }
      
      const div = document.createElement("div");
      div.className = "p-3 border rounded-lg hover:bg-yellow-50 hover:border-yellow-300 cursor-pointer transition-all";
      div.innerHTML = `
        <div class="flex items-center justify-between">
          <div>
            <div class="font-medium text-lg">${room.roomNo}</div>
            <div class="text-sm text-gray-600">${room.type}</div>
            <div class="text-xs ${reasonClass} mt-1">${reasonText}</div>
            ${roomCatalogInfo ? `<div class="text-xs text-gray-500 mt-1">Capacity: ${roomCatalogInfo.capacity} guests</div>` : ''}
          </div>
          <div class="text-right">
            <div class="text-lg font-semibold text-gray-800">${fmtINR(getRoomPrice(room.type))}</div>
            <div class="text-xs text-gray-500">per night</div>
            ${isUpgrade ? '<div class="text-xs text-blue-500">Upgrade</div>' : ''}
          </div>
        </div>
      `;
      div.addEventListener("click", () => assignRoomToRequest(room.roomNo, requestId, modalId));
      recList.appendChild(div);
    });
  }

  $(`${modalId}-close`).addEventListener("click", ()=> mc.innerHTML = "");
  $(`${modalId}-cancel`).addEventListener("click", ()=> mc.innerHTML = "");
}

function getRoomPrice(roomType) {
  const catalog = roomCatalog.find(r => r.type === roomType);
  return catalog ? catalog.price : 0;
}

function assignRoomToRequest(roomNo, requestId, modalId) {
  // Remove any previously assigned room for this request
  const previousRoom = state.roomAssignments[requestId];
  if (previousRoom) {
    delete state.selectedRooms[previousRoom];
  }
  
  // Assign new room
  state.roomAssignments[requestId] = roomNo;
  addRoomToSelectedCart(roomNo, requestId);
  
  // Close modal and refresh UI
  $("modalsContainer").innerHTML = "";
  renderRoomRequestCards();
  renderSelectedCart();
  showToast(`Room ${roomNo} assigned successfully!`, "success");
}

function addRoomToSelectedCart(roomNo, requestId = null){
  const inv = roomInventory.find(r=>r.roomNo===roomNo);
  if(!inv) return;
  const nights = nightsBetween(booking.newCheckIn, booking.newCheckOut);
  const rate = roomCatalog.find(rc => rc.type === inv.type)?.price || 0;
  state.selectedRooms[roomNo] = { roomNo, type: inv.type, rate, nights, requestId };
}

/* ============================
   Reset Selected (modal)
   ============================ */
function hookResetSelected(){
  $("resetSelectedBtn").addEventListener("click", ()=> {
    if(Object.keys(state.selectedRooms).length === 0){ showToast("No selected rooms to reset.","info"); return; }
    showConfirmModal("Reset Selected Rooms", "Remove all selected rooms from the cart? This will not affect already locked rooms.", ()=> {
      state.selectedRooms = {};
      renderSelectedCart();
      showToast("Selected rooms reset.", "success");
    });
  });
}

/* ============================
   Send to Customer with Room Locking
   ============================ */
function hookSendToCustomer(){
  $("sendToCustomerBtn").addEventListener("click", ()=> {
    if($("sendToCustomerBtn").disabled) return;
    
    const assignedRooms = Object.values(state.selectedRooms);
    const lockDuration = 30; // 30 minutes lock duration
    
    showRoomLockingModal(assignedRooms, lockDuration, ()=> {
      lockRoomsAndSendToCustomer(assignedRooms, lockDuration);
    });
  });
}

function showRoomLockingModal(rooms, lockDuration, onConfirm){
  const mc = $("modalsContainer");
  const roomCount = rooms.length;
  const roomList = rooms.map(r => `${r.roomNo} (${r.type})`).join(', ');
  
  mc.innerHTML = `
    <div class="fixed inset-0 z-70 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black bg-opacity-40"></div>
      <div class="relative bg-white rounded-2xl p-6 shadow-2xl max-w-lg w-full border-2 border-orange-200">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 bg-orange-100 rounded-full flex items-center justify-center">
            <i class="fas fa-exclamation-triangle text-orange-600 text-xl"></i>
          </div>
          <div>
            <h3 class="text-lg font-bold text-gray-900">Confirm Locking Rooms</h3>
            <div class="text-sm text-orange-600">This action will temporarily reserve rooms</div>
          </div>
        </div>
        
        <div class="bg-orange-50 border border-orange-200 rounded-lg p-4 mb-4">
          <p class="text-sm text-gray-700 mb-3">
            You are about to lock <strong>${roomCount} room(s)</strong> for <strong>${lockDuration} minutes</strong>. 
            During this time, they won't be available for other bookings.
          </p>
          
          <div class="text-xs text-gray-600 mb-2">
            <strong>Rooms to be locked:</strong>
          </div>
          <div class="text-xs bg-white rounded border p-2 font-mono text-gray-800">
            ${roomList}
          </div>
        </div>
        
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
          <div class="flex items-start gap-2">
            <i class="fas fa-info-circle text-yellow-600 text-sm mt-0.5"></i>
            <div class="text-xs text-gray-700">
              <strong>What happens next:</strong>
              <ul class="mt-1 space-y-1 ml-2">
                <li>• Selected rooms will be locked in the system</li>
                <li>• Customer will receive booking modification notification</li>
                <li>• You'll be redirected to the Bookings management page</li>
              </ul>
            </div>
          </div>
        </div>

        <div class="flex gap-3 pt-2">
          <button id="lockConfirmBtn" class="flex-1 px-4 py-3 bg-orange-600 text-white font-medium rounded-lg hover:bg-orange-700 transition-colors">
            <i class="fas fa-lock mr-2"></i>
            Confirm & Lock
          </button>
          <button id="lockCancelBtn" class="flex-1 px-4 py-3 border border-gray-300 text-gray-700 font-medium rounded-lg hover:bg-gray-50 transition-colors">
            Cancel
          </button>
        </div>
      </div>
    </div>
  `;

  $("lockConfirmBtn").addEventListener("click", ()=> { mc.innerHTML = ""; onConfirm && onConfirm(); });
  $("lockCancelBtn").addEventListener("click", ()=> mc.innerHTML = "");
}

function lockRoomsAndSendToCustomer(rooms, lockDuration) {
  // Simulate locking rooms in database
  const lockedUntil = new Date(Date.now() + lockDuration * 60 * 1000);
  
  // Lock rooms in inventory (simulate database update)
  rooms.forEach(room => {
    const invRoom = roomInventory.find(r => r.roomNo === room.roomNo);
    if (invRoom) {
      invRoom.available = false;
      invRoom.lockedUntil = lockedUntil;
      invRoom.lockedFor = booking.id;
    }
  });
  
  // Show success message
  const roomCount = rooms.length;
  showToast(`${roomCount} room(s) locked and sent to customer successfully! Redirecting...`, "success");
  
  // Redirect to bookings page after 2 seconds
  setTimeout(() => {
    window.location.href = '/Features/BookingManagement/Admin/Bookings/index.html';
  }, 2000);
}

/* ============================
   Confirm modal helper
   ============================ */
function showConfirmModal(title, message, onConfirm){
  const mc = $("modalsContainer");
  mc.innerHTML = `
    <div class="fixed inset-0 z-70 flex items-center justify-center p-4">
      <div class="absolute inset-0 bg-black bg-opacity-30"></div>
      <div class="relative bg-white rounded-2xl p-6 shadow max-w-md w-full">
        <h3 class="text-lg font-semibold mb-2">${title}</h3>
        <p class="text-sm text-gray-600 mb-4">${message}</p>
        <div class="flex justify-end gap-3">
          <button id="confirmCancel" class="px-4 py-2 border rounded">Cancel</button>
          <button id="confirmOk" class="px-4 py-2 bg-indigo-600 text-white rounded">Confirm</button>
        </div>
      </div>
    </div>
  `;
  $("confirmCancel").addEventListener("click", ()=> mc.innerHTML = "");
  $("confirmOk").addEventListener("click", ()=> { mc.innerHTML = ""; onConfirm && onConfirm(); });
}

/* ============================
   Toast
   ============================ */
function showToast(msg, type="success"){
  const t = $("toast");
  t.classList.remove("bg-green-500","bg-red-500","bg-blue-500","bg-yellow-500");
  t.classList.add(type==="success"?"bg-green-500":type==="error"?"bg-red-500":type==="info"?"bg-blue-500":"bg-yellow-500");
  t.textContent = msg;
  t.style.transform = 'translateY(0)';
  t.style.opacity = '1';
  setTimeout(()=> { t.style.transform = 'translateY(-24px)'; t.style.opacity='0'; }, 2600);
}



/* ============================
   Tabs wiring
   ============================ */
function hookTabs(){
  const detailsBtn = $("tab-details"), roomsBtn = $("tab-rooms");
  const detailsPanel = $("panel-details"), roomsPanel = $("panel-rooms");
  function switchTab(btn,panel){
    [detailsBtn, roomsBtn].forEach(b=>{ b.classList.remove("tab-active"); b.classList.add("tab-inactive"); });
    btn.classList.add("tab-active"); btn.classList.remove("tab-inactive");
    [detailsPanel, roomsPanel].forEach(p=>p.classList.add("hidden"));
    panel.classList.remove("hidden");
  }
  detailsBtn.addEventListener("click", ()=> switchTab(detailsBtn,detailsPanel));
  roomsBtn.addEventListener("click", ()=> switchTab(roomsBtn,roomsPanel));
}

/* ============================
   Init
   ============================ */
document.addEventListener("DOMContentLoaded", ()=> {
  initUI();
});

</script>
</body>
</html>
