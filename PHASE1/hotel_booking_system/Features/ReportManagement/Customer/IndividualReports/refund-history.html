<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>My Stay History</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

  <!-- Navbar placeholder (will be loaded via fetch) -->
  <div id="navbar"></div>

  <div class="flex flex-1 mt-20 max-w-7xl mx-auto w-full px-4 gap-6 relative">

    <!-- Main Sidebar (Global Navigation) -->
    <aside class="w-64 bg-white shadow-lg rounded-2xl p-6 h-fit">
      <nav class="space-y-4 text-gray-700 font-medium">
        <a href="/Features/LandingPages/Customer/index.html" class="block py-2 border-b hover:text-yellow-600">Overview</a>
        <a href="/Features/BookingManagement/MyBookings/index.html" class="block py-2 border-b hover:text-yellow-600">My Bookings</a>
        <a href="/Features/UserManagement/Customer/SavedRoomsCustomer/index.html" class="block py-2 border-b hover:text-yellow-600">Wishlist</a>
        <a href="/Features/IssueManagement/Customer/MyIssues/index.html" class="block py-2 border-b hover:text-yellow-600">My Issues</a>
        <a href="/Features/RefundManagement/Customer/MyRefunds/index.html" class="block py-2 border-b hover:text-yellow-600">My Refunds</a>
        <a href="/Features/UserManagement/Customer/ProfileDisplayCustomer/index.html" class="block py-2 border-b hover:text-yellow-600">Profile</a>
        <a href="/Features/ReportManagement/Customer/ReportSections/index.html" class="block py-2 border-b text-yellow-700 font-semibold">Reports</a>
      </nav>
    </aside>

    <!-- Reports Sidebar (Hidden Drawer, Scrollable) -->
    <aside id="sidebar"
      class="fixed top-20 left-0 w-72 h-[80vh] overflow-y-auto bg-white border-r border-gray-200 shadow-lg rounded-r-xl transform -translate-x-full transition-transform duration-300 z-30">
      <div class="p-4">
        <input id="reportSearch" type="text" placeholder="Search reports"
          class="w-full border rounded-lg px-3 py-2 mb-4 text-sm focus:ring-yellow-500 focus:border-yellow-500"/>
        <nav id="reportList" class="space-y-4 text-gray-700 text-sm">
          <div>
            <h3 class="font-semibold text-gray-800 mb-2">Bookings</h3>
            <ul class="space-y-1">
              <li><a href="room-occupancy.html" class="block px-2 py-1 rounded font-semibold">My Stay History</a></li>
              <li><a href="cancellation-history.html" class="block px-2 py-1 hover:bg-yellow-100 rounded">Cancellation History</a></li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold text-gray-800 mb-2">Payments & Refunds</h3>
            <ul class="space-y-1">
              <li><a href="payments-received.html" class="block px-2 py-1 hover:bg-yellow-100 rounded">Payments Made</a></li>
              <li><a href="refund-history.html" class="block px-2 py-1 hover:bg-yellow-100 rounded">Refund History</a></li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold text-gray-800 mb-2">Issues</h3>
            <ul>
              <li><a href="issues-summary.html" class="block px-2 py-1 hover:bg-yellow-100 rounded">My Reported Issues</a></li>
            </ul>
          </div>
          <div>
            <h3 class="font-semibold text-gray-800 mb-2">Profile</h3>
            <ul>
              <li><a href="saved-rooms.html" class="block px-2 py-1 hover:bg-yellow-100 rounded">Wishlist</a></li>
              <li><a href="review-history.html" class="block px-2 py-1 hover:bg-yellow-100 rounded">My Reviews & Ratings</a></li>
            </ul>
          </div>
          <!-- Add more report links here if needed -->
        </nav>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 p-6 bg-white shadow rounded-xl relative">
      <div class="flex items-center justify-between mb-6">
        <!-- Left: Title -->
        <h1 class="text-xl font-semibold flex items-center space-x-2">
          <span class="material-icons text-gray-600 cursor-pointer" id="menuToggle" title="Open reports menu">menu</span>
          <span>My Stay History</span>
          <span class="text-gray-500 text-sm">(From 01/01/2024 To 23/09/2025)</span>
        </h1>

        <!-- Right: Actions -->
        <div class="flex items-center space-x-3">
          <!-- Print -->
          <div class="relative group">
            <button id="printBtn" class="border px-3 py-2 rounded hover:bg-gray-100 flex items-center space-x-2">
              <span class="material-icons text-gray-600">print</span>
            </button>
            <div class="absolute hidden group-hover:block bg-white border rounded shadow-lg mt-2 right-0 text-sm">
              <a href="#" class="block px-4 py-2 hover:bg-gray-100">Print Preference</a>
            </div>
          </div>

          <!-- Export -->
          <div class="relative">
            <button id="exportToggle" class="border px-3 py-2 rounded hover:bg-gray-100 flex items-center space-x-2">
              <span>Export As</span>
              <span class="material-icons">expand_more</span>
            </button>
            <div id="exportMenu" class="absolute hidden bg-white border rounded shadow-lg mt-2 right-0 text-sm z-40">
              <a href="#" id="exportPDF" class="block px-4 py-2 hover:bg-gray-100">PDF</a>
              <a href="#" id="exportXLS" class="block px-4 py-2 hover:bg-gray-100">XLSX (Excel)</a>
              <a href="#" id="exportCSV" class="block px-4 py-2 hover:bg-gray-100">CSV</a>
            </div>
          </div>
        </div>
      </div>

      <!-- Filters -->
      <div class="flex flex-wrap items-center space-x-4 mb-6">
        <div class="min-w-[180px]">
          <label class="block text-xs font-medium text-gray-600">Date Range</label>
          <select id="dateRange" class="border rounded px-3 py-2 text-sm w-full">
            <option>This Month</option>
            <option>Last 3 Months</option>
            <option>This Year</option>
            <option value="custom">Custom</option>
          </select>
        </div>
        <div class="min-w-[150px]">
          <label class="block text-xs font-medium text-gray-600">Status</label>
          <select id="statusFilter" class="border rounded px-3 py-2 text-sm w-full">
            <option>All</option>
            <option>Completed</option>
            <option>Cancelled</option>
          </select>
        </div>
        <div class="flex-1"></div>
        <button id="runReportBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Run Report</button>
      </div>

      <!-- Report Table -->
      <div class="overflow-x-auto rounded-xl border">
        <table class="w-full text-sm">
          <thead class="bg-gray-100 border-b">
            <tr>
              <th class="text-left p-3 font-medium">Booking ID</th>
              <th class="text-left p-3 font-medium">Room Type</th>
              <th class="text-left p-3 font-medium">Check-In</th>
              <th class="text-left p-3 font-medium">Check-Out</th>
              <th class="text-center p-3 font-medium">Nights</th>
              <th class="text-right p-3 font-medium">Amount Paid</th>
              <th class="text-center p-3 font-medium">Certificate</th>
            </tr>
          </thead>
          <tbody id="reportBody">
            <tr class="border-b hover:bg-gray-50">
              <td class="p-3">#1234</td>
              <td class="p-3">Deluxe Room</td>
              <td class="p-3">12 Sep 2025</td>
              <td class="p-3">14 Sep 2025</td>
              <td class="text-center p-3">2</td>
              <td class="text-right p-3">₹8,000</td>
              <td class="text-center p-3"><a href="#" class="text-blue-600 hover:underline">Download</a></td>
            </tr>
            <tr class="border-b hover:bg-gray-50">
              <td class="p-3">#1235</td>
              <td class="p-3">Suite</td>
              <td class="p-3">01 Aug 2025</td>
              <td class="p-3">05 Aug 2025</td>
              <td class="text-center p-3">4</td>
              <td class="text-right p-3">₹25,000</td>
              <td class="text-center p-3"><a href="#" class="text-blue-600 hover:underline">Download</a></td>
            </tr>
          </tbody>
          <!-- Total Row -->
          <tfoot class="bg-gray-50 border-t">
            <tr>
              <td colspan="4" class="p-3 font-semibold text-right">Total</td>
              <td id="totalNights" class="text-center p-3 font-semibold">6</td>
              <td id="totalAmount" class="text-right p-3 font-semibold">₹33,000</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </main>
  </div>

  <!-- Footer placeholder -->
  <div id="footer"></div>

  <!-- PDF Export Modal (advanced) -->
  <div id="pdfModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white w-11/12 md:w-11/12 lg:w-4/5 rounded-xl shadow-lg p-6 max-h-[90vh] overflow-y-auto">
      <div class="flex items-start justify-between">
        <h2 class="text-lg font-semibold">Export Report as PDF</h2>
        <button id="pdfClose" class="text-gray-500 hover:text-gray-800">✕</button>
      </div>

      <p class="text-sm text-gray-600 mt-3">You can protect the exported report with a password to keep your data secure.</p>

      <label class="flex items-center space-x-2 mt-4">
        <input id="pdfProtect" type="checkbox" class="w-4 h-4">
        <span class="text-sm">I want to protect this file with a password.</span>
      </label>

      <button id="pdfCustomizeToggle" class="text-sm text-blue-600 mt-2 inline-flex items-center">
        Customize the details in the export file
        <span class="material-icons text-sm ml-1">expand_more</span>
      </button>

      <!-- Choose Details (collapsible) -->
      <div id="pdfDetails" class="mt-3">
        <h3 class="font-medium mb-2">Choose Details to Display</h3>
        <div class="grid grid-cols-3 gap-3 text-sm mb-4">
          <label class="flex items-center space-x-2"><input type="checkbox" checked> <span>Organization Name</span></label>
          <label class="flex items-center space-x-2"><input type="checkbox" id="pdfPageNum"> <span>Page Number</span></label>
          <label class="flex items-center space-x-2"><input type="checkbox"> <span>Generated By</span></label>
          <label class="flex items-center space-x-2"><input type="checkbox"> <span>Generated Date</span></label>
          <label class="flex items-center space-x-2"><input type="checkbox"> <span>Generated Time</span></label>
        </div>

        <h3 class="font-medium mb-2">Temporary Note</h3>
        <textarea id="pdfNote" rows="3" class="w-full border rounded-lg p-2 text-sm mb-4" placeholder="Enter any notes..."></textarea>

        <h3 class="font-medium mb-2">Report Layout</h3>
        <div class="grid grid-cols-2 gap-4 text-sm mb-4">
          <div>
            <label class="block text-xs text-gray-600">Table Density</label>
            <select id="pdfDensity" class="w-full border rounded-lg p-2">
              <option>Classic</option>
              <option>Compact</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-gray-600">Table Design</label>
            <select id="pdfDesign" class="w-full border rounded-lg p-2">
              <option>Default</option>
              <option>Minimal</option>
              <option>Striped</option>
            </select>
          </div>
        </div>

        <label class="flex items-center space-x-2 mb-4 text-sm">
          <input id="pdfAutoResize" type="checkbox"> 
          <span>Re-size the table and its font automatically to fit the content within the table.</span>
        </label>

        <div class="grid grid-cols-2 gap-4 text-sm mb-4">
          <div>
            <label class="block text-xs text-gray-600">Paper Size</label>
            <select id="pdfPaper" class="w-full border rounded-lg p-2">
              <option>A4</option>
              <option>Letter</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-gray-600">Orientation</label>
            <div class="flex space-x-4 mt-1">
              <label class="flex items-center space-x-2"><input type="radio" name="pdfOrient" value="portrait" checked> <span>Portrait</span></label>
              <label class="flex items-center space-x-2"><input type="radio" name="pdfOrient" value="landscape"> <span>Landscape</span></label>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4 text-sm mb-4">
          <div>
            <label class="block text-xs text-gray-600">Font Family</label>
            <select id="pdfFont" class="w-full border rounded-lg p-2">
              <option>Ubuntu</option>
              <option>Arial</option>
              <option>Times New Roman</option>
            </select>
          </div>
          <div>
            <label class="block text-xs text-gray-600">Margins (cm)</label>
            <div class="grid grid-cols-4 gap-2 mt-1">
              <input id="mTop" type="number" step="0.1" value="0.9" class="border rounded-lg p-1 text-sm" title="Top">
              <input id="mBottom" type="number" step="0.1" value="0.7" class="border rounded-lg p-1 text-sm" title="Bottom">
              <input id="mLeft" type="number" step="0.1" value="0.9" class="border rounded-lg p-1 text-sm" title="Left">
              <input id="mRight" type="number" step="0.1" value="0.7" class="border rounded-lg p-1 text-sm" title="Right">
            </div>
          </div>
        </div>
      </div>

      <!-- Preview + Actions -->
      <div class="flex flex-col lg:flex-row lg:items-start lg:space-x-6 mt-6">
        <div class="flex-1">
          <!-- could show summary or sample lines here -->
        </div>

        <div class="w-full lg:w-[320px]">
          <div class="border rounded-lg p-3 bg-gray-50">
            <div class="text-xs text-gray-500 mb-2 text-center font-medium">PREVIEW</div>
            <div class="bg-white p-3 border rounded text-xs text-gray-500 h-60 overflow-hidden">
              <!-- Fake preview content -->
              <div class="text-center mb-2 font-semibold">Demo Org</div>
              <div class="h-2 bg-gray-100 rounded mb-2"></div>
              <div class="space-y-1 mt-3">
                <div class="h-2 bg-gray-100 rounded"></div>
                <div class="h-2 bg-gray-100 rounded"></div>
                <div class="h-2 bg-gray-100 rounded"></div>
                <div class="h-2 bg-gray-100 rounded"></div>
                <div class="h-2 bg-gray-100 rounded"></div>
              </div>
            </div>
          </div>

          <div class="flex justify-end mt-4 space-x-3">
            <button id="pdfCancel" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
            <button id="pdfExportBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Export PDF</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- XLS/CSV Export Modal (simple) -->
  <div id="xlsModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white w-11/12 md:w-2/3 lg:w-1/2 rounded-xl shadow-lg p-6">
      <div class="flex items-start justify-between">
        <h2 class="text-lg font-semibold">Export Report</h2>
        <button id="xlsClose" class="text-gray-500 hover:text-gray-800">✕</button>
      </div>

      <p class="text-sm text-gray-600 mt-3">You can protect the exported report with a password to keep your data secure.</p>

      <label class="flex items-center space-x-2 mt-4">
        <input id="xlsProtect" type="checkbox" class="w-4 h-4">
        <span class="text-sm">I want to protect this file with a password.</span>
      </label>

      <label class="flex items-center space-x-2 mt-3">
        <input id="xlsViewOnly" type="checkbox" class="w-4 h-4">
        <span class="text-sm">Export this report based on my current view</span>
      </label>

      <button id="xlsCustomize" class="text-sm text-blue-600 mt-3 inline-flex items-center">
        Customize the details in the export file
        <span class="material-icons text-sm ml-1">expand_more</span>
      </button>

      <div id="xlsCustomizePanel" class="mt-3 hidden text-sm">
        <label class="flex items-center space-x-2"><input type="checkbox" checked> Organization Name</label>
        <label class="flex items-center space-x-2 mt-1"><input type="checkbox"> Page Number</label>
        <!-- minimal customization options for XLSX/CSV -->
      </div>

      <div class="flex justify-end mt-6 space-x-3">
        <button id="xlsCancel" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
        <button id="xlsExportBtn" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Export</button>
      </div>
    </div>
  </div>

  <!-- Custom Date Modal -->
  <div id="dateModal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white w-11/12 md:w-2/3 lg:w-1/2 rounded-xl shadow-lg p-6">
      <div class="flex items-start justify-between">
        <h2 class="text-lg font-semibold">Select Custom Date Range</h2>
        <button id="dateClose" class="text-gray-500 hover:text-gray-800">✕</button>
      </div>

      <p class="text-sm text-gray-600 mt-3">Choose a start and end date for the report.</p>

      <div class="flex gap-4 mt-6">
        <div class="flex-1">
          <label class="block text-xs text-gray-600">From</label>
          <input id="customFrom" type="date" class="w-full border rounded p-2" value="2024-01-01">
        </div>
        <div class="flex-1">
          <label class="block text-xs text-gray-600">To</label>
          <input id="customTo" type="date" class="w-full border rounded p-2" value="2025-12-31">
        </div>
      </div>

      <div class="flex justify-end mt-6 space-x-3">
        <button id="dateCancel" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300">Cancel</button>
        <button id="dateApply" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Apply</button>
      </div>
    </div>
  </div>
    <!-- // fetch("/Features/Components/Navbars/LoggedCustomerNavbar/index.html").then(r => r.text()).then(d => { document.getElementById("navbar").innerHTML = d; }).catch(()=>{}); -->
    <!-- // fetch("/Features/Components/Footers/CustomerFooter/index.html").then(r => r.text()).then(d => { document.getElementById("footer").innerHTML = d; }).catch(()=>{}); -->

    <script>
            fetch("/Features/Components/Navbars/LoggedCustomerNavbar/index.html").then(r => r.text()).then(d => { document.getElementById("navbar").innerHTML = d; }).catch(()=>{});
    fetch("/Features/Components/Footers/CustomerFooter/index.html").then(r => r.text()).then(d => { document.getElementById("footer").innerHTML = d; }).catch(()=>{});
    
     const menuToggle = document.getElementById("menuToggle");
  const sidebar = document.getElementById("sidebar");
  let overlay;
  menuToggle.addEventListener("click", () => {
    const isClosed = sidebar.classList.contains("-translate-x-full");
    sidebar.classList.toggle("-translate-x-full");
    toggleOverlay(isClosed); // show overlay only if we just opened
  });

  function toggleOverlay(show) {
    if (window.innerWidth > 1024) return; // don't overlay on large screens
    if (!overlay) {
      overlay = document.createElement("div");
      overlay.id = "drawerOverlay";
      overlay.className = "fixed inset-0 bg-black bg-opacity-30 z-20";
      overlay.addEventListener("click", () => {
        sidebar.classList.add("-translate-x-full");
        overlay.remove();
      });
    }
    if (show && !document.body.contains(overlay)) {
      document.body.appendChild(overlay);
    } else if (!show) {
      overlay?.remove();
    }
    if (sidebar.classList.contains("-translate-x-full")) overlay?.remove();
  }

   const exportToggle = document.getElementById("exportToggle");
  const exportMenu = document.getElementById("exportMenu");
  exportToggle.addEventListener("click", (e) => {
    e.stopPropagation();
    exportMenu.classList.toggle("hidden");
  });
  document.addEventListener("click", () => {
    if (!exportMenu.classList.contains("hidden")) exportMenu.classList.add("hidden");
  });


    const reportSearch = document.getElementById("reportSearch");
  const reportList = document.getElementById("reportList");
  reportSearch.addEventListener("input", () => {
    const q = reportSearch.value.trim().toLowerCase();
    Array.from(reportList.querySelectorAll("a")).forEach((a) => {
      const txt = a.textContent.trim().toLowerCase();
      a.style.display = txt.includes(q) ? "" : "none";
    });
  });


   const dateRange = document.getElementById("dateRange");
  const dateModal = document.getElementById("dateModal");
  const dateClose = document.getElementById("dateClose");
  const dateCancel = document.getElementById("dateCancel");
  const dateApply = document.getElementById("dateApply");

  dateRange.addEventListener("change", () => {
    if (dateRange.value === "custom") {
      openDateModal();
    }
  });

  function openDateModal() {
    dateModal.classList.remove("hidden");
    dateModal.classList.add("flex");
  }
  function closeDateModal() {
    dateModal.classList.add("hidden");
    dateModal.classList.remove("flex");
  }
  dateClose.addEventListener("click", closeDateModal);
  dateCancel.addEventListener("click", closeDateModal);
  dateApply.addEventListener("click", () => {
    const from = document.getElementById("customFrom").value;
    const to = document.getElementById("customTo").value;
    dateRange.value = `${from} → ${to}`;
    closeDateModal();
  });
  const pdfModal = document.getElementById("pdfModal");
  const pdfClose = document.getElementById("pdfClose");
  const pdfCancel = document.getElementById("pdfCancel");
  const pdfExportBtn = document.getElementById("pdfExportBtn");
  const pdfCustomizeToggle = document.getElementById("pdfCustomizeToggle");
  const pdfDetails = document.getElementById("pdfDetails");
  let pdfDetailsVisible = true;

  document.getElementById("exportPDF").addEventListener("click", (e) => {
    e.preventDefault();
    pdfModal.classList.remove("hidden");
    pdfModal.classList.add("flex");
  });
  pdfClose.addEventListener("click", () => pdfModal.classList.add("hidden"));
  pdfCancel.addEventListener("click", () => pdfModal.classList.add("hidden"));
  pdfCustomizeToggle.addEventListener("click", () => {
    pdfDetailsVisible = !pdfDetailsVisible;
    pdfDetails.style.display = pdfDetailsVisible ? "block" : "none";
  });

  pdfExportBtn.addEventListener("click", () => {
    const note = document.getElementById("pdfNote").value || "";
    const density = document.getElementById("pdfDensity").value;
    const design = document.getElementById("pdfDesign").value;
    const paper = document.getElementById("pdfPaper").value;
    const font = document.getElementById("pdfFont").value;
    const top = document.getElementById("mTop").value;

    let content = `My Stay History Report\n\nGenerated: ${new Date().toLocaleString()}\n\nOptions:\n- Density: ${density}\n- Design: ${design}\n- Paper: ${paper}\n- Font: ${font}\n- Top margin: ${top} cm\n\nTemporary Note:\n${note}\n\nRows:\n`;

    document.querySelectorAll("#reportBody tr").forEach((row) => {
      const arr = Array.from(row.querySelectorAll("td"))
        .slice(0, 6)
        .map((td) => td.textContent.trim());
      content += arr.join(" | ") + "\n";
    });

    const blob = new Blob([content], { type: "application/pdf" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `stay-history-${new Date().toISOString().slice(0, 10)}.pdf`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    pdfModal.classList.add("hidden");
  });

  /* ------------------------
     XLS / CSV modal
     ------------------------ */
  const xlsModal = document.getElementById("xlsModal");
  const xlsClose = document.getElementById("xlsClose");
  const xlsCancel = document.getElementById("xlsCancel");
  const xlsExportBtn = document.getElementById("xlsExportBtn");
  const xlsCustomizeBtn = document.getElementById("xlsCustomize");
  const xlsCustomizePanel = document.getElementById("xlsCustomizePanel");

  document.getElementById("exportXLS").addEventListener("click", (e) => {
    e.preventDefault();
    xlsModal.classList.remove("hidden");
    xlsModal.classList.add("flex");
  });
  document.getElementById("exportCSV").addEventListener("click", (e) => {
    e.preventDefault();
    xlsModal.classList.remove("hidden");
    xlsModal.classList.add("flex");
  });
  xlsClose.addEventListener("click", () => xlsModal.classList.add("hidden"));
  xlsCancel.addEventListener("click", () => xlsModal.classList.add("hidden"));
  xlsCustomizeBtn.addEventListener("click", () => {
    xlsCustomizePanel.classList.toggle("hidden");
  });
  xlsExportBtn.addEventListener("click", () => {
    const rows = [];
    rows.push("Booking ID,Room Type,Check-In,Check-Out,Nights,Amount Paid");
    document.querySelectorAll("#reportBody tr").forEach((tr) => {
      const cols = Array.from(tr.querySelectorAll("td"))
        .slice(0, 6)
        .map((td) => td.textContent.trim().replace(/₹/g, "").replace(/,/g, ""));
      rows.push(cols.join(","));
    });
    const csv = rows.join("\n");
    const blob = new Blob([csv], { type: "text/csv" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `stay-history-${new Date().toISOString().slice(0, 10)}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
    xlsModal.classList.add("hidden");
  });
  (function () {
  // ensure overlay var exists in this scope (if your other code also uses overlay that's fine)
  var overlay = window.__reportsDrawerOverlay || null;
  window.__reportsDrawerOverlay = overlay;

  /* ------------------------
     Print button (DOM-safe, no template backticks)
     ------------------------ */
  var printBtn = document.getElementById('printBtn');
  if (printBtn) {
    printBtn.addEventListener('click', function () {
      try {
        var table = document.querySelector('main table');
        if (!table) {
          showToast('Nothing to print', 3000);
          return;
        }

        // open new window and inject DOM nodes (avoid long string templates)
        var w = window.open('', '_blank');
        if (!w) {
          showToast('Popup blocked. Allow popups to print.', 4000);
          return;
        }

        var doc = w.document;

        // Create head + style safely
        var head = doc.head || doc.getElementsByTagName('head')[0] || doc.createElement('head');
        var styleEl = doc.createElement('style');
        styleEl.type = 'text/css';
        // simple print styles
        styleEl.appendChild(doc.createTextNode(
          'body{font-family:Arial,Helvetica,sans-serif;margin:20px;color:#222}' +
          'h3{font-size:18px;margin-bottom:12px}' +
          'table{width:100%;border-collapse:collapse}' +
          'th,td{padding:8px;border:1px solid #ddd;text-align:left}' +
          'thead{background:#f2f2f2}'
        ));
        head.appendChild(styleEl);

        // Build body content: heading + cloned table
        var body = doc.body || doc.getElementsByTagName('body')[0] || doc.createElement('body');
        // clear body
        body.innerHTML = '';
        var heading = doc.createElement('h3');
        heading.textContent = 'My Stay History';
        body.appendChild(heading);

        // Clone the table node into new document (preserves markup but not events)
        var clone = table.cloneNode(true);
        body.appendChild(clone);

        // If document wasn't attached, append head/body
        if (!doc.head) doc.appendChild(head);
        if (!doc.body) doc.appendChild(body);

        // Focus and print after a tiny delay to let browser render the DOM
        w.focus();
        setTimeout(function () { w.print(); }, 250);
      } catch (err) {
        console.error('Print failed:', err);
        showToast('Print failed — check console', 4000);
      }
    });
  }

  /* ------------------------
     Run Report button
     ------------------------ */
  var runBtn = document.getElementById('runReportBtn');
  if (runBtn) {
    runBtn.addEventListener('click', function () {
      showToast('Report applied — showing filtered results (demo)', 2500);
      recalcTotals();
    });
  }

  /* ------------------------
     Toast utility (safe DOM)
     ------------------------ */
  function showToast(msg, timeout) {
    timeout = typeof timeout === 'number' ? timeout : 3000;
    var t = document.createElement('div');
    t.setAttribute('role', 'status');
    t.className = 'fixed top-6 right-6 bg-green-600 text-white px-4 py-2 rounded shadow z-50';
    t.style.fontFamily = 'Inter, Arial, Helvetica, sans-serif';
    t.textContent = msg;
    document.body.appendChild(t);

    // subtle fade-out
    setTimeout(function () {
      t.style.transition = 'opacity 300ms ease';
      t.style.opacity = '0';
      setTimeout(function () { try { t.remove(); } catch (e) { /* ignore */ } }, 300);
    }, timeout);
  }

  /* ------------------------
     Recalculate totals from table rows
     ------------------------ */
  function recalcTotals() {
    var nights = 0;
    var amount = 0;
    var rows = document.querySelectorAll('#reportBody tr');
    rows.forEach(function (tr) {
      try {
        var nightsCell = tr.children[4];
        var amountCell = tr.children[5];
        var n = parseInt((nightsCell && nightsCell.textContent) ? nightsCell.textContent.trim() : '0', 10) || 0;
        var amtText = (amountCell && amountCell.textContent) ? amountCell.textContent.trim() : '0';
        amtText = amtText.replace(/₹/g, '').replace(/,/g, '').trim();
        var a = parseFloat(amtText) || 0;
        nights += n;
        amount += a;
      } catch (e) { /* skip malformed row */ }
    });

    var totalNightsEl = document.getElementById('totalNights');
    var totalAmountEl = document.getElementById('totalAmount');
    if (totalNightsEl) totalNightsEl.textContent = nights;
    if (totalAmountEl) totalAmountEl.textContent = '₹' + amount.toLocaleString('en-IN');
  }

  // initialize totals safely
  try { recalcTotals(); } catch (e) { /* ignore */ }

  /* ------------------------
     Keyboard & Escape behavior (defensive)
     ------------------------ */
  document.addEventListener('keydown', function (ev) {
    if (ev.key === 'Escape' || ev.key === 'Esc') {
      var pdfModal = document.getElementById('pdfModal');
      var xlsModal = document.getElementById('xlsModal');
      var dateModal = document.getElementById('dateModal');
      var exportMenu = document.getElementById('exportMenu');
      var sb = document.getElementById('sidebar');

      if (pdfModal) pdfModal.classList.add('hidden');
      if (xlsModal) xlsModal.classList.add('hidden');
      if (dateModal) dateModal.classList.add('hidden');
      if (exportMenu) exportMenu.classList.add('hidden');
      if (sb) sb.classList.add('-translate-x-full');

      // overlay cleanup (if overlay exists and is attached)
      if (overlay && overlay.parentNode) {
        overlay.parentNode.removeChild(overlay);
      }
    }
  });

  // responsive cleanup overlay when resizing
  window.addEventListener('resize', function () {
    if (window.innerWidth > 1024 && overlay && overlay.parentNode) {
      overlay.parentNode.removeChild(overlay);
    }
  });

  // expose recalc for external calls if needed
  window.recalcStayTotals = recalcTotals;
})();
    </script>
</body>
</html>
