<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LuxuryStay - Room Management (LocalStorage)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    /* small polish */
    .stat-badge { min-width: 72px; display: inline-block; text-align: center; }
    /* ensure modal scroll works on small screens */
    #addRoomModal .max-h-\[90vh\] { max-height: 90vh; }
  </style>
</head>
<body class="bg-gray-50">

  <!-- ✅ Navbar -->
  <div id="navbar"></div>

  <!-- ✅ Sidebar -->
  <div id="sidebar" class="fixed top-16 left-0 w-64 h-screen shadow-lg bg-white"></div>

  <!-- ✅ Main Content -->
  <main class="ml-64 pt-16 p-8 h-screen overflow-y-auto">

    <!-- Page Title + Add -->
    <div class="mb-6 flex justify-between items-center">
      <div>
        <h2 class="text-2xl font-bold text-gray-800">Room Management</h2>
        <p class="text-gray-600">Manage room availability, status, and bookings. (LocalStorage-backed demo)</p>
      </div>
      <button onclick="toggleAddRoomModal()" class="p-3 bg-yellow-600 text-white rounded-full hover:bg-yellow-700 shadow">
        <span class="material-icons">add</span>
      </button>
    </div>

    <!-- ✅ Search + Filter Box -->
    <div class="bg-white shadow-lg border border-gray-200 rounded-xl p-6 space-y-4 mb-8">
      <!-- Search -->
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Search</label>
        <div class="relative">
          <span class="absolute inset-y-0 left-0 flex items-center pl-3 text-gray-500 material-icons">search</span>
          <input id="searchBox" type="text" placeholder="Room No, Guest Name"
            class="w-full pl-10 p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 shadow-sm">
        </div>
      </div>

      <!-- Filters -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Room Status</label>
          <select id="filterStatus" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
            <option value="All">All</option>
            <option value="Available">Available</option>
            <option value="Occupied">Occupied</option>
            <option value="Maintenance">Maintenance</option>
            <option value="Frozen">Frozen</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Room Type</label>
          <select id="filterType" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
            <option value="All">All</option>
            <option value="Deluxe">Deluxe</option>
            <option value="Suite">Suite</option>
            <option value="Standard">Standard</option>
            <option value="Executive">Executive</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Next Check-in Date</label>
          <input id="filterCheckIn" type="date" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-yellow-500">
        </div>
      </div>

      <div class="flex justify-end">
        <button id="applyFilterBtn" class="px-5 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 shadow-md flex items-center space-x-2">
          <span class="material-icons text-sm">filter_alt</span>
          <span>Apply Filters</span>
        </button>
      </div>
    </div>

    <!-- ✅ Table -->
    <div class="overflow-x-auto bg-white shadow-lg border border-gray-200 rounded-xl">
      <table class="w-full text-sm">
        <thead class="bg-yellow-50 border-b border-gray-300">
          <tr>
            <th class="p-3 text-left font-semibold text-gray-700">Room No</th>
            <th class="p-3 text-left font-semibold text-gray-700">Room Type</th>
            <th class="p-3 text-left font-semibold text-gray-700">Status</th>
            <th class="p-3 text-left font-semibold text-gray-700">Guest Name</th>
            <th class="p-3 text-left font-semibold text-gray-700">Next Check-out</th>
            <th class="p-3 text-left font-semibold text-gray-700">Next Check-in</th>
            <th class="p-3 text-center font-semibold text-gray-700">Action</th>
          </tr>
        </thead>
        <tbody id="roomTableBody" class="divide-y divide-gray-200">
          <!-- Rows dynamically generated -->
        </tbody>
      </table>
    </div>

    <!-- ✅ Pagination -->
    <nav class="flex flex-col md:flex-row justify-between items-center mt-6 space-y-4 md:space-y-0">
      <button onclick="prevPage()" class="px-5 py-2 flex items-center space-x-2 border rounded-full bg-gray-200 hover:bg-gray-300">
        <span class="material-icons text-sm">chevron_left</span><span>Prev</span>
      </button>
      <ul id="paginationNumbers" class="flex space-x-2"></ul>
      <button onclick="nextPage()" class="px-5 py-2 flex items-center space-x-2 border rounded-full bg-gray-200 hover:bg-gray-300">
        <span>Next</span><span class="material-icons text-sm">chevron_right</span>
      </button>
      <div class="flex items-center space-x-2">
        <label for="pageInput" class="text-sm text-gray-600 font-medium">Jump to:</label>
        <input id="pageInput" type="number" min="1" placeholder="Page #"
          class="w-20 px-3 py-2 border rounded-lg focus:ring-2 focus:ring-yellow-500 focus:border-yellow-500 shadow-sm">
        <button onclick="jumpToPage()" class="px-4 py-2 rounded-lg bg-blue-500 text-white hover:bg-blue-600 shadow flex items-center space-x-1">
          <span class="material-icons text-sm">login</span><span>Go</span>
        </button>
      </div>
    </nav>

  </main>

  <!-- =========================
       Add Room Modal (unchanged UI)
       Will wire to LocalStorage
       ========================= -->
<div id="addRoomModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
  <div class="bg-white w-full max-w-2xl max-h-[90vh] rounded-2xl shadow-lg p-6 relative overflow-y-auto">

    <!-- Close Button -->
    <button onclick="toggleAddRoomModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-700">
      <span class="material-icons">close</span>
    </button>

    <!-- Modal Title -->
    <div class="flex items-center gap-3 mb-6">
      <h2 class="text-xl font-bold text-gray-800">Add Room</h2>
    </div>

    <!-- Form -->
    <form id="addRoomForm" class="space-y-6">
      <!-- Room number -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Room number:</label>
        <input id="roomNumber" type="text" placeholder="Enter the Room Number" 
          class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-yellow-500" required>
      </div>

      <!-- Room Type (Dropdown) -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Room Type:</label>
        <select id="roomType" 
          class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-yellow-500" required>
          <option value="">Select Type</option>
          <option value="Deluxe">Deluxe</option>
          <option value="Suite">Suite</option>
          <option value="Standard">Standard</option>
          <option value="Executive">Executive</option>
          <option value="Family">Family</option>
          <option value="Villa">Villa</option>
        </select>
      </div>

      <!-- Price / Night -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Price / Night:</label>
        <input id="roomPrice" type="number" placeholder="Enter the Price per Night" 
          class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-yellow-500" required>
      </div>

      <!-- Capacity (Adults + Children) -->
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-gray-700 font-medium mb-1">Adults Capacity:</label>
          <input id="roomAdults" type="number" min="1" placeholder="Max Adults" 
            class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-yellow-500" required>
        </div>
        <div>
          <label class="block text-gray-700 font-medium mb-1">Children Capacity:</label>
          <input id="roomChildren" type="number" min="0" placeholder="Max Children" 
            class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-yellow-500" required>
        </div>
      </div>

      <!-- Room Description -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Room Description:</label>
        <textarea id="roomDesc" rows="3" placeholder="Enter room description" 
          class="w-full border p-3 rounded-lg focus:ring-2 focus:ring-yellow-500"></textarea>
      </div>

      <!-- Room Amenities -->
      <div>
        <label class="block text-gray-700 font-medium mb-2">Room Amenities:</label>
        <div class="grid grid-cols-3 gap-2">
          <label class="flex items-center gap-2"><input type="checkbox" value="AC" class="amenity accent-yellow-600"> AC</label>
          <label class="flex items-center gap-2"><input type="checkbox" value="Wi-Fi" class="amenity accent-yellow-600"> Wi-Fi</label>
          <label class="flex items-center gap-2"><input type="checkbox" value="TV" class="amenity accent-yellow-600"> TV</label>
          <label class="flex items-center gap-2"><input type="checkbox" value="Mini Bar" class="amenity accent-yellow-600"> Mini Bar</label>
          <label class="flex items-center gap-2"><input type="checkbox" value="Balcony" class="amenity accent-yellow-600"> Balcony</label>
          <label class="flex items-center gap-2"><input type="checkbox" value="Heater" class="amenity accent-yellow-600"> Heater</label>
        </div>
      </div>

      <!-- Room Images -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Room Images:</label>
        <div class="border-dashed border-2 border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-50">
          <span class="material-icons text-4xl text-orange-500">add_photo_alternate</span>
          <p class="text-gray-500 text-sm">Click to upload images (UI-only for demo)</p>
          <input type="file" multiple class="hidden">
        </div>
      </div>

      <!-- Room Videos -->
      <div>
        <label class="block text-gray-700 font-medium mb-1">Room Videos:</label>
        <div class="border-dashed border-2 border-gray-300 rounded-lg p-6 text-center cursor-pointer hover:bg-gray-50">
          <span class="material-icons text-4xl text-orange-500">video_library</span>
          <p class="text-gray-500 text-sm">Click to upload videos (UI-only for demo)</p>
          <input type="file" accept="video/*" multiple class="hidden">
        </div>
      </div>

      <!-- Buttons -->
      <div class="flex justify-end gap-4 pt-4">
        <button type="reset" id="addReset" 
          class="px-5 py-2 bg-yellow-400 hover:bg-yellow-500 text-black rounded-lg shadow">
          Reset Details
        </button>
        <button type="submit" 
          class="px-5 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg shadow">
          Add Room
        </button>
      </div>
    </form>
  </div>
</div>


  <!-- =========================
       Scripts
       ========================= -->
  <script>
    /******************************
     * LocalStorage helper layer  *
     ******************************/
    function getRooms() {
      try {
        return JSON.parse(localStorage.getItem('rooms')) || [];
      } catch (e) {
        console.error('corrupt rooms in localStorage, resetting', e);
        localStorage.removeItem('rooms');
        return [];
      }
    }

    function saveRooms(rooms) {
      localStorage.setItem('rooms', JSON.stringify(rooms));
    }

    // seed a single dummy record (if none)
    (function seedIfEmpty() {
      if (!localStorage.getItem('rooms')) {
        const seed = [{
          roomNumber: "101",
          type: "Deluxe",
          price: 4500,
          status: "Available",
          description: "Spacious deluxe room with sea view, king-size bed, and complimentary breakfast.",
          amenities: ["AC", "Wi-Fi", "TV"],
          guestName: "-",
          nextCheckIn: "2025-09-25",
          nextCheckOut: "-",
          frozen: false,
          adultsCapacity: 2,
          childrenCapacity: 1,
        }];
        saveRooms(seed);
      }
    })();

    /******************************
     * Rendering / table logic     *
     ******************************/
    let currentPage = 1;
    const rowsPerPage = 5;

    function renderRoomsTable(filteredRooms = null) {
      const rooms = filteredRooms || getRooms();
      const tbody = document.getElementById('roomTableBody');
      tbody.innerHTML = '';

      // create rows (we keep DOM stable)
      rooms.forEach((room, idx) => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-gray-50';
        tr.dataset.index = idx;

        const statusBadge = room.frozen ? `<span class="px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-medium">Frozen</span>` :
                             (room.status === 'Available' ? `<span class="px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-medium">Available</span>` :
                             (room.status === 'Occupied' ? `<span class="px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 text-xs font-medium">Occupied</span>` :
                             `<span class="px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-medium">Maintenance</span>`));

        tr.innerHTML = `
          <td class="p-3">${escapeHtml(room.roomNumber)}</td>
          <td class="p-3">${escapeHtml(room.type)}</td>
          <td class="p-3">${statusBadge}</td>
          <td class="p-3">${escapeHtml(room.guestName || '-')}</td>
          <td class="p-3">${escapeHtml(room.nextCheckOut || '-')}</td>
          <td class="p-3">${escapeHtml(room.nextCheckIn || '-')}</td>
          <td class="p-3 text-center flex justify-center space-x-2">
            <button onclick="viewRoom('${encodeURIComponent(room.roomNumber)}')" class="px-3 py-1 bg-blue-500 text-white rounded-lg hover:bg-blue-600 text-sm">View</button>
            <button onclick="editRoom('${encodeURIComponent(room.roomNumber)}')" class="px-3 py-1 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 text-sm">Edit</button>
            <button onclick="toggleFreeze('${encodeURIComponent(room.roomNumber)}')" class="px-3 py-1 ${room.frozen ? 'bg-emerald-500' : 'bg-purple-500'} text-white rounded-lg hover:opacity-90 text-sm">${room.frozen ? 'Unfreeze' : 'Freeze'}</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

      // after DOM update, apply pagination
      setupPagination();
      showPage(1);
    }

    function escapeHtml(str) {
      if (typeof str !== 'string') return str;
      return str.replace(/[&<>"']/g, function(m) {
        return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m];
      });
    }

    /******************************
     * Modal Toggle Logic
     ******************************/
    function toggleAddRoomModal() {
      const modal = document.getElementById('addRoomModal');
      if (!modal) return;

      // toggle hidden
      modal.classList.toggle('hidden');

      // prevent background scroll when modal is open
      if (!modal.classList.contains('hidden')) {
        document.body.style.overflow = 'hidden';
      } else {
        document.body.style.overflow = '';
      }
    }


    /******************************
     * Freeze / Unfreeze handler  *
     ******************************/
    function toggleFreeze(encodedRoomNumber) {
      const roomNumber = decodeURIComponent(encodedRoomNumber);
      const rooms = getRooms();
      const idx = rooms.findIndex(r => r.roomNumber === roomNumber);
      if (idx === -1) { alert('Room not found'); return; }
      rooms[idx].frozen = !rooms[idx].frozen;
      // optional: if frozen set status to Frozen label
      if (rooms[idx].frozen) rooms[idx].status = 'Frozen';
      else rooms[idx].status = rooms[idx].status === 'Frozen' ? 'Available' : rooms[idx].status;
      saveRooms(rooms);
      renderRoomsTable(applyCurrentFiltersAndSearch());
    }

    /******************************
     * Add Room wiring (LocalStorage)
     ******************************/
    document.getElementById('addRoomForm').addEventListener('submit', function (e) {
      e.preventDefault();
      const roomNum = document.getElementById('roomNumber').value.trim();
      const type = document.getElementById('roomType').value.trim();
      const price = parseInt(document.getElementById('roomPrice').value, 10) || 0;
      const adults = parseInt(document.getElementById('roomAdults').value, 10) || 1;
      const children = parseInt(document.getElementById('roomChildren').value, 10) || 0;
      const description = document.getElementById('roomDesc').value.trim();
      const amenities = Array.from(document.querySelectorAll('.amenity:checked')).map(x => x.value);

      if (!roomNum || !type) {
        alert('Please provide room number and type.');
        return;
      }

      const rooms = getRooms();

      // prevent duplicate roomNumber
      if (rooms.some(r => r.roomNumber === roomNum)) {
        alert('Room number already exists. Please use a different number or edit the existing room.');
        return;
      }

      const newRoom = {
        roomNumber: roomNum,
        type,
        price,
        status: 'Available',
        description,
        amenities,
        guestName: '-',
        nextCheckIn: '-',
        nextCheckOut: '-',
        frozen: false,
        adultsCapacity: adults,
        childrenCapacity: children,
      };

      rooms.push(newRoom);
      saveRooms(rooms);

      // close modal, reset, refresh
      toggleAddRoomModal();
      document.getElementById('addRoomForm').reset();
      renderRoomsTable(applyCurrentFiltersAndSearch());
      // show newly added page if needed
      showPage( Math.ceil(rooms.length / rowsPerPage) );
    });

    // reset button behavior - keep modal open after reset
    document.getElementById('addReset').addEventListener('click', function () {
      // optional: keep default values
      // no special action required; HTML form reset will clear inputs
    });

    /******************************
     * View / Edit handlers (redirect stubs)
     * - They store selectedRoomNumber in localStorage
     * - RoomDetails and EditRoom pages should read selectedRoomNumber
     ******************************/
    function viewRoom(encodedRoomNumber) {
      const roomNumber = decodeURIComponent(encodedRoomNumber);
      localStorage.setItem('selectedRoomNumber', roomNumber);
      // navigate to your Room Details page (keeps same structure you had)
      window.location.href = '../AdminRoomDetails/index.html';
    }

    function editRoom(encodedRoomNumber) {
      const roomNumber = decodeURIComponent(encodedRoomNumber);
      localStorage.setItem('selectedRoomNumber', roomNumber);
      window.location.href = '../AdminEditRoom/index.html';
    }

    /******************************
     * Pagination helpers
     ******************************/
    function setupPagination() {
      const rows = document.querySelectorAll('#roomTableBody tr');
      const totalPages = Math.max(1, Math.ceil(rows.length / rowsPerPage));
      const container = document.getElementById('paginationNumbers');
      container.innerHTML = '';
      for (let i = 1; i <= totalPages; i++) {
        const btn = document.createElement('button');
        btn.textContent = i;
        btn.className = `px-4 py-2 rounded-full ${i === currentPage ? 'bg-yellow-500 text-white shadow' : 'bg-gray-200 hover:bg-yellow-100'}`;
        btn.onclick = () => showPage(i);
        container.appendChild(btn);
      }
    }

    function showPage(page) {
      const rows = document.querySelectorAll('#roomTableBody tr');
      const totalPages = Math.max(1, Math.ceil(rows.length / rowsPerPage));
      if (page < 1) page = 1;
      if (page > totalPages) page = totalPages;
      currentPage = page;
      rows.forEach((row, i) => {
        row.style.display = (i >= (page - 1) * rowsPerPage && i < page * rowsPerPage) ? '' : 'none';
      });

      // refresh pagination buttons appearance
      const buttons = document.querySelectorAll('#paginationNumbers button');
      buttons.forEach((b, idx) => {
        const p = idx + 1;
        b.className = `px-4 py-2 rounded-full ${p === currentPage ? 'bg-yellow-500 text-white shadow' : 'bg-gray-200 hover:bg-yellow-100'}`;
      });
    }

    function prevPage() { showPage(currentPage - 1); }
    function nextPage() { showPage(currentPage + 1); }
    function jumpToPage() {
      const v = parseInt(document.getElementById('pageInput').value, 10);
      if (v) showPage(v);
    }

    /******************************
     * Filtering & Search
     ******************************/
    function applyCurrentFiltersAndSearch() {
      const rooms = getRooms();
      const q = (document.getElementById('searchBox').value || '').trim().toLowerCase();
      const status = document.getElementById('filterStatus').value;
      const type = document.getElementById('filterType').value;
      const checkInDate = document.getElementById('filterCheckIn').value; // exact match on nextCheckIn for demo

      let filtered = rooms.slice();

      if (q) {
        filtered = filtered.filter(r =>
          String(r.roomNumber).toLowerCase().includes(q) ||
          (r.guestName && r.guestName.toLowerCase().includes(q))
        );
      }

      if (status && status !== 'All') {
        if (status === 'Frozen') {
          filtered = filtered.filter(r => r.frozen === true);
        } else {
          filtered = filtered.filter(r => r.status === status && r.frozen !== true);
        }
      }

      if (type && type !== 'All') {
        filtered = filtered.filter(r => r.type === type);
      }

      if (checkInDate) {
        filtered = filtered.filter(r => r.nextCheckIn === checkInDate);
      }

      return filtered;
    }

    document.getElementById('applyFilterBtn').addEventListener('click', function () {
      const filtered = applyCurrentFiltersAndSearch();
      renderRoomsTable(filtered);
    });

    document.getElementById('searchBox').addEventListener('input', function () {
      const filtered = applyCurrentFiltersAndSearch();
      renderRoomsTable(filtered);
    });

    // Optionally allow filter change to auto-update
    ['filterStatus','filterType','filterCheckIn'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('change', () => {
        const filtered = applyCurrentFiltersAndSearch();
        renderRoomsTable(filtered);
      });
    });

    /******************************
     * Navbar & Sidebar loaders (keeps your structure)
     ******************************/
    fetch('../AdminMainPageNavbar/index.html').then(res => res.text()).then(html => {
      document.getElementById('navbar').innerHTML = html;
    }).catch(() => {
      // fallback minimal nav if file not available (demo)
      document.getElementById('navbar').innerHTML = `
        <div class="fixed top-0 left-0 right-0 bg-white shadow z-30">
          <div class="max-w-7xl mx-auto p-4 flex justify-between items-center">
            <div class="font-bold text-yellow-600">LuxuryStay</div>
            <div class="text-sm text-gray-600">Admin</div>
          </div>
        </div>`;
    });

    fetch('../AdminMainPageSidebar/index.html').then(res => res.text()).then(html => {
      document.getElementById('sidebar').innerHTML = html;
      // highlight active
      const currentPage = 'room';
      document.querySelectorAll('#sidebar a').forEach(link => {
        if (link.dataset && link.dataset.page === currentPage) {
          link.classList.add('text-yellow-600','font-bold');
        }
      });
    }).catch(() => {
      // fallback minimal sidebar
      document.getElementById('sidebar').innerHTML = `
        <div class="p-6">
          <div class="mb-6 font-bold text-yellow-600">LuxuryStay</div>
          <nav class="space-y-2 text-sm">
            <a class="block py-2 text-gray-700" data-page="dashboard">Dashboard</a>
            <a class="block py-2 text-gray-700" data-page="room">Rooms</a>
            <a class="block py-2 text-gray-700" data-page="customers">Customers</a>
          </nav>
        </div>`;
    });

    /******************************
     * Initial render on load
     ******************************/
    document.addEventListener('DOMContentLoaded', function () {
      renderRoomsTable();
      // wire ESC to close modal (small nicety)
      document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape') {
          const m = document.getElementById('addRoomModal');
          if (m && !m.classList.contains('hidden')) m.classList.add('hidden');
        }
      });
    });

    /******************************
     * Small utilities
     ******************************/
    // safe decode URI for inline handlers
    function decodeRoomNo(encoded) {
      try { return decodeURIComponent(encoded); } catch(e) { return encoded; }
    }

    /******************************
     * End of script
     ******************************/
  </script>

</body>
</html>
